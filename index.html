<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0d2a1b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Green Noise" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no" />

  <title>Tom Swift’s Green Noise Transmuter</title>

  <!--
    Single‑file PWA notes:
    - Manifest + Service Worker are created at runtime via Blob URLs so you can keep this as one HTML file.
    - For installability on HTTPS: this will work when hosted on a secure origin.
  -->

  <style>
    :root{
      --bg-parchment-1:#f2e7cc;
      --bg-parchment-2:#e6d7b5;
      --ink:#143323;
      --panel:#0f3a2a;
      --panel-dark:#0b2a1f;
      --panel-hi:#13523a;
      --brass-1:#d7c07a;
      --brass-2:#9a7c2e;
      --brass-3:#5e4614;
      --amber:#ffcf66;
      --amber-dim:#caa24c;
      --neon:#45ff99;
      --neon-dim:#1db06a;
      --shadow: rgba(0,0,0,.35);
      --glass: rgba(255, 255, 255, 0.08);
      --radius: 18px;
      --radius2: 22px;
      --font-display: ui-serif, Georgia, "Times New Roman", Times, serif;
      --font-ui: ui-serif, Georgia, "Times New Roman", Times, serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%;}
    body{
      margin:0;
      color: var(--ink);
      font-family: var(--font-ui);
      overflow-y: auto;
      overflow-x: hidden;
      background:
        radial-gradient(1200px 900px at 30% 10%, rgba(255,255,255,.7), rgba(255,255,255,0) 60%),
        radial-gradient(900px 800px at 75% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--bg-parchment-1), var(--bg-parchment-2));
      position:relative;
    }

    /* subtle “paper noise” */
    body::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.02) 0 1px, rgba(0,0,0,0) 1px 3px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.015) 0 1px, rgba(0,0,0,0) 1px 4px);
      mix-blend-mode:multiply;
      opacity:.35;
      pointer-events:none;
    }

    /* blueprint-ish schematics */
    body::after{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 20% 70%, rgba(20, 80, 55, .10), rgba(0,0,0,0) 55%),
        radial-gradient(circle at 80% 40%, rgba(20, 80, 55, .08), rgba(0,0,0,0) 45%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'%3E%3Cg fill='none' stroke='%2314533a' stroke-opacity='0.12' stroke-width='1'%3E%3Cpath d='M20 40h60v40H20z'/%3E%3Cpath d='M120 30h80v50h-80z'/%3E%3Cpath d='M40 130h140v60H40z'/%3E%3Cpath d='M80 80v50'/%3E%3Cpath d='M160 80v50'/%3E%3Ccircle cx='50' cy='55' r='6'/%3E%3Ccircle cx='150' cy='55' r='6'/%3E%3Ccircle cx='70' cy='165' r='8'/%3E%3Ccircle cx='110' cy='165' r='8'/%3E%3Ccircle cx='150' cy='165' r='8'/%3E%3Cpath d='M56 55h18M156 55h18'/%3E%3Cpath d='M70 173v12M110 173v12M150 173v12'/%3E%3Cpath d='M20 100h60M200 100h-80'/%3E%3C/g%3E%3C/svg%3E");
      opacity:.5;
      pointer-events:none;
      transform: rotate(-1deg);
    }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
      position:relative;
      z-index:1;
    }

    .device{
      width:min(980px, 96vw);
      max-height: 94vh;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      padding: 18px;
      border-radius: calc(var(--radius2) + 10px);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0) 35%),
        linear-gradient(180deg, #1a3a2b, #0d261c);
      box-shadow:
        0 24px 60px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.12),
        inset 0 -1px 0 rgba(0,0,0,.25);
      border: 3px solid rgba(215, 192, 122, .55);
      position:relative;
    }

    /* brass frame */
    .device::before{
      content:"";
      position:absolute; inset: 10px;
      border-radius: calc(var(--radius2) + 2px);
      border: 2px solid rgba(215, 192, 122, .35);
      box-shadow: inset 0 0 0 1px rgba(90, 60, 12, .35);
      pointer-events:none;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      padding: 8px 10px 0 10px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .brand .title{
      font-family: var(--font-display);
      letter-spacing: .06em;
      text-transform: uppercase;
      font-weight: 700;
      color: #e7e1c8;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
      font-size: clamp(14px, 2.2vw, 18px);
    }

    .brand .subtitle{
      font-family: var(--font-display);
      letter-spacing:.18em;
      text-transform: uppercase;
      color: rgba(255, 220, 140, .9);
      font-size: clamp(10px, 1.6vw, 12px);
    }

    .screws{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .screw{
      width: 18px; height: 18px;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 60% 70%, rgba(0,0,0,.35), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, var(--brass-1), var(--brass-2));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35), 0 2px 6px rgba(0,0,0,.35);
      position:relative;
    }
    .screw::after{
      content:"";
      position:absolute; inset: 7px 2px;
      border-top:2px solid rgba(60, 40, 10, .55);
      transform: rotate(18deg);
    }

    .panel{
      border-radius: var(--radius2);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 30%),
        linear-gradient(180deg, var(--panel-hi), var(--panel));
      border: 2px solid rgba(215, 192, 122, .5);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08), 0 12px 28px rgba(0,0,0,.22);
      padding: 16px;
      display:grid;
      grid-template-columns: 1.05fr 1.35fr;
      gap: 14px;
      min-height: 360px;
    }

    .panel h1{
      grid-column: 1 / -1;
      margin: 0;
      font-size: clamp(22px, 3.6vw, 34px);
      line-height: 1.1;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #efe7cc;
      text-shadow: 0 3px 0 rgba(0,0,0,.25);
    }

    .left, .right{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .section{
      border-radius: var(--radius);
      border: 1px solid rgba(215, 192, 122, .35);
      background: rgba(0,0,0,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      padding: 12px;
    }

    .label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin-bottom: 8px;
      color: rgba(255, 220, 140, .92);
      text-transform: uppercase;
      letter-spacing: .14em;
      font-size: 11px;
    }

    .tiny{
      color: rgba(255, 220, 140, .75);
      letter-spacing:.10em;
      font-size: 10px;
    }

    .controlsRow{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    /* Big tactile toggle */
    .transmit{
      display:flex;
      align-items:center;
      gap: 12px;
    }

    .btnBig{
      width: 96px; height: 96px;
      border-radius: 50%;
      border: 2px solid rgba(215,192,122,.65);
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.22), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 50% 60%, rgba(0,0,0,.35), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, #124d36, #0a2b1f);
      box-shadow:
        inset 0 2px 0 rgba(255,255,255,.12),
        inset 0 -10px 18px rgba(0,0,0,.35),
        0 12px 22px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
      user-select:none;
      touch-action: manipulation;
      outline: none;
    }
    .btnBig:active{ transform: translateY(1px) scale(.995); }
    .btnBig::after{
      content:"";
      position:absolute; inset: 16px;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.25), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 50% 50%, rgba(69,255,153,.35), rgba(0,0,0,0) 62%);
      filter: blur(.2px);
      opacity:.75;
    }
    .btnBig .glyph{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      color: rgba(255, 255, 255, .9);
      font-size: 34px;
      text-shadow: 0 0 18px rgba(69,255,153,.35);
      z-index:2;
    }

    .status{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 200px;
    }

    .statusLine{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: #efe7cc;
      font-size: 14px;
      letter-spacing:.06em;
    }

    .lamp{
      width: 12px; height:12px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.65), rgba(255,255,255,0) 35%),
                  radial-gradient(circle at 55% 60%, rgba(0,0,0,.35), rgba(0,0,0,0) 60%),
                  radial-gradient(circle at 50% 50%, rgba(255,207,102,.85), rgba(255,207,102,.25) 50%, rgba(0,0,0,0) 70%);
      box-shadow: 0 0 14px rgba(255, 207, 102, .35), inset 0 1px 0 rgba(255,255,255,.25);
    }

    .lamp.off{ 
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 35%),
                  radial-gradient(circle at 50% 50%, rgba(160,160,160,.22), rgba(0,0,0,0) 62%);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      opacity:.75;
    }

    .readout{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(215,192,122,.45);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)),
        rgba(0,0,0,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .digits{
      font-family: var(--mono);
      font-size: 18px;
      letter-spacing:.06em;
      color: var(--amber);
      text-shadow: 0 0 18px rgba(255, 207, 102, .25);
      white-space:nowrap;
    }

    .btnSmall{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(215,192,122,.55);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.14), rgba(255,255,255,0) 50%),
        linear-gradient(180deg, #1c4f3a, #0c2b20);
      color: #efe7cc;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-family: var(--font-display);
      font-size: 12px;
      cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 6px 14px rgba(0,0,0,.25);
      user-select:none;
      touch-action: manipulation;
    }
    .btnSmall:active{ transform: translateY(1px); }

    /* Timer dial */
    .dialWrap{ display:flex; flex-direction:column; gap:10px; }
    .dialRow{ display:flex; align-items:center; gap:10px; }

    input[type="range"]{
      width:100%;
      accent-color: var(--brass-1);
    }

    .tickline{
      height: 8px;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(215,192,122,.35), rgba(215,192,122,.05));
      position:relative;
      overflow:hidden;
    }

    .tickline::after{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg, rgba(0,0,0,.35) 0 1px, rgba(0,0,0,0) 1px 18px);
      opacity:.25;
    }

    .dialVal{
      font-family: var(--mono);
      color: var(--amber);
      font-size: 14px;
      letter-spacing:.06em;
      text-shadow: 0 0 16px rgba(255,207,102,.2);
      min-width: 112px;
      text-align:right;
    }

    /* Gauge */
    .gauge{
      width: 160px;
      height: 88px;
      border-radius: 1000px 1000px 16px 16px;
      border: 1px solid rgba(215,192,122,.55);
      background:
        radial-gradient(circle at 50% 120%, rgba(255,255,255,.12), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.35));
      position:relative;
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .gauge::before{
      content:"";
      position:absolute; inset: 10px 10px 8px 10px;
      border-radius: 999px 999px 14px 14px;
      background:
        radial-gradient(circle at 50% 110%, rgba(69,255,153,.18), rgba(0,0,0,0) 55%),
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.05), rgba(255,255,255,0) 60%);
      border: 1px solid rgba(255,255,255,.05);
    }

    .needle{
      position:absolute;
      left: 50%;
      bottom: 14px;
      width: 2px;
      height: 58px;
      transform-origin: bottom center;
      background: linear-gradient(180deg, rgba(255,207,102,.15), rgba(255,207,102,.95));
      box-shadow: 0 0 14px rgba(255,207,102,.25);
    }

    .needle::after{
      content:"";
      position:absolute;
      left: 50%;
      bottom: -6px;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(180deg, var(--brass-1), var(--brass-2));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25), 0 4px 10px rgba(0,0,0,.35);
      border: 1px solid rgba(0,0,0,.2);
    }

    /* Visualizer */
    .scope{
      border-radius: var(--radius);
      border: 1px solid rgba(215,192,122,.55);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)),
        rgba(0,0,0,.30);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    canvas{
      width:100%;
      height: 220px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 50% 40%, rgba(69,255,153,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25));
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }

    .foot{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 0 10px 10px 10px;
      color: rgba(239,231,204,.8);
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 10px;
      font-family: var(--font-display);
      opacity:.9;
    }

    .hint{
      opacity:.85;
      max-width: 58ch;
    }

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(215,192,122,.55);
      background: rgba(0,0,0,.18);
    }

    .modalBackdrop{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.45);
      z-index: 10;
    }
    .modal{
      width:min(560px, 95vw);
      border-radius: 18px;
      border: 2px solid rgba(215,192,122,.55);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0) 30%),
        linear-gradient(180deg, #174f38, #0b2a1f);
      box-shadow: 0 18px 48px rgba(0,0,0,.5);
      padding: 14px;
      color: #efe7cc;
    }
    .modal h2{
      margin:0 0 8px 0;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size: 14px;
      color: rgba(255, 220, 140, .95);
    }
    .modal p{ margin:0 0 12px 0; line-height:1.35; color: rgba(239,231,204,.92); }

    .modalActions{ display:flex; justify-content:flex-end; gap:10px; }

    /* Responsiveness */
    @media (max-width: 780px){
      .panel{ grid-template-columns: 1fr; }
      canvas{ height: 200px; }
      .btnBig{ width: 88px; height: 88px; }
      .status{ min-width: unset; flex: 1; }
      .gauge{ width: 140px; }
    }

    @media (max-height: 720px){
      canvas{ height: 170px; }
      .panel{ min-height: 320px; }
    }

    /* Reduce motion preference */
    @media (prefers-reduced-motion: reduce){
      .btnBig:active{ transform:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="device" role="application" aria-label="Tom Swift Green Noise Transmuter">
      <div class="topbar">
        <div class="brand">
          <div class="title">Tom Swift’s</div>
          <div class="subtitle">Green Noise Transmuter</div>
        </div>
        <div class="screws" aria-hidden="true">
          <div class="screw"></div>
          <div class="screw"></div>
          <div class="screw"></div>
          <div class="screw"></div>
        </div>
      </div>

      <div class="panel">
        <h1>Green Noise Transmuter</h1>

        <div class="left">
          <div class="section">
            <div class="label">
              <span>Transmission</span>
              <span class="tiny">Toggle carrier</span>
            </div>

            <div class="controlsRow">
              <div class="transmit">
                <button id="btnToggle" class="btnBig" aria-pressed="false" aria-label="Start transmission">
                  <div class="glyph" id="btnGlyph">▶</div>
                </button>
                <div class="status">
                  <div class="statusLine">
                    <div style="display:flex; align-items:center; gap:10px;">
                      <div id="lamp" class="lamp off" aria-hidden="true"></div>
                      <div id="statusText">STANDBY</div>
                    </div>
                    <div id="sr" class="tiny" aria-live="polite">Ready</div>
                  </div>

                  <div class="readout" aria-label="Countdown readout">
                    <div>
                      <div class="tiny">COUNTDOWN</div>
                      <div class="digits" id="countdown">00:00:00</div>
                    </div>
                    <button id="btnReset" class="btnSmall" type="button" title="Stop and reset timer">Reset</button>
                  </div>
                </div>
              </div>

              <div class="gauge" aria-label="Signal gauge">
                <div id="needle" class="needle" style="transform: translateX(-50%) rotate(-65deg);"></div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="label">
              <span>Sleep Timer</span>
              <span class="tiny">1 min → 3 hours</span>
            </div>

            <div class="dialWrap">
              <div class="dialRow">
                <input id="timerRange" type="range" min="1" max="180" value="30" step="1" />
                <div class="dialVal" id="timerLabel">30 min</div>
              </div>
              <div class="tickline" aria-hidden="true"></div>
              <div class="tiny" style="display:flex; justify-content:space-between;">
                <span>1m</span><span>30m</span><span>1h</span><span>2h</span><span>3h</span>
              </div>
              <div class="controlsRow" style="justify-content:flex-start;">
                <button class="btnSmall" id="btnSetTimer" type="button">Arm Timer</button>
                <button class="btnSmall" id="btnClearTimer" type="button">Clear</button>
                <button class="btnSmall" id="btnAbout" type="button">About</button>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="label">
              <span>Volume</span>
              <span class="tiny">Bakelite attenuator</span>
            </div>
            <div class="dialRow">
              <input id="volRange" type="range" min="0" max="1" step="0.01" value="0.35" />
              <div class="dialVal" id="volLabel">35%</div>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="scope">
            <div class="label">
              <span>Oscilloscope</span>
              <span class="tiny">Green/Amber trace</span>
            </div>
            <canvas id="scope" width="900" height="360" aria-label="Audio visualizer"></canvas>
            <div class="tiny" id="vizNote">Tip: tap TRANSMIT to begin. (Audio needs a user gesture.)</div>
          </div>

          <div class="section">
            <div class="label">
              <span>Green Noise Profile</span>
              <span class="tiny">~500 Hz emphasis</span>
            </div>
            <div class="controlsRow" style="gap:10px;">
              <div style="flex:1;">
                <div class="tiny" style="margin-bottom:6px;">CENTER FREQUENCY</div>
                <input id="centerRange" type="range" min="250" max="1200" value="500" step="1" />
              </div>
              <div class="dialVal" id="centerLabel">500 Hz</div>
            </div>

            <div class="controlsRow" style="gap:10px; margin-top:10px;">
              <div style="flex:1;">
                <div class="tiny" style="margin-bottom:6px;">BANDWIDTH (Q)</div>
                <input id="qRange" type="range" min="0.3" max="8" value="1.2" step="0.1" />
              </div>
              <div class="dialVal" id="qLabel">Q 1.2</div>
            </div>

            <div class="tiny" style="margin-top:10px; line-height:1.3; color:rgba(239,231,204,.86);">
              “Green noise” is loosely defined in the wild. Here we shape white noise with filters to
              concentrate energy around the mid‑range (default ~500 Hz), producing a cozy, less‑boomy wash.
            </div>
          </div>
        </div>
      </div>

      <div class="foot">
        <div class="hint">Use headphones at low volume. The Transmuter will fade out gently when the timer expires.</div>
        <div class="badge">© State Technologies • 1930s-ish</div>
      </div>
    </div>
  </div>

  <!-- Custom “no alerts” modal -->
  <div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="mTitle" aria-describedby="mBody">
    <div class="modal">
      <h2 id="mTitle">About this apparatus</h2>
      <p id="mBody"></p>
      <div class="modalActions">
        <button id="btnCloseModal" class="btnSmall" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Tiny helpers
    // -----------------------------
    const $ = (sel) => document.querySelector(sel);

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function fmtHMS(totalSeconds){
      totalSeconds = Math.max(0, Math.floor(totalSeconds));
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      const pad = (n)=>String(n).padStart(2,'0');
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    function humanMinutes(mins){
      if (mins < 60) return `${mins} min`;
      const h = Math.floor(mins/60);
      const m = mins % 60;
      if (m === 0) return `${h} hr`;
      return `${h} hr ${m} min`;
    }

    // -----------------------------
    // PWA: runtime manifest + service worker (single-file friendly)
    // -----------------------------
    (function setupPWA(){
      // Simple generated icon (SVG -> PNG-ish via data URL). iOS uses apple-touch-icon; we can provide SVG data.
      const iconSVG = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'>
          <defs>
            <radialGradient id='g' cx='35%' cy='30%'>
              <stop offset='0%' stop-color='#46ff9a'/>
              <stop offset='55%' stop-color='#1db06a'/>
              <stop offset='100%' stop-color='#0b2a1f'/>
            </radialGradient>
            <linearGradient id='b' x1='0' x2='0' y1='0' y2='1'>
              <stop offset='0%' stop-color='#d7c07a'/>
              <stop offset='100%' stop-color='#9a7c2e'/>
            </linearGradient>
          </defs>
          <rect x='28' y='28' width='456' height='456' rx='88' fill='#0d2a1b' stroke='url(#b)' stroke-width='18'/>
          <circle cx='256' cy='250' r='154' fill='url(#g)' opacity='0.95'/>
          <path d='M220 192 L336 250 L220 308 Z' fill='#fff' opacity='0.9'/>
          <text x='256' y='430' font-family='Georgia,Times New Roman,serif' font-size='52' text-anchor='middle' fill='#ffcf66' letter-spacing='6'>GN</text>
        </svg>
      `);

      const appleIcon = document.createElement('link');
      appleIcon.rel = 'apple-touch-icon';
      appleIcon.href = `data:image/svg+xml,${iconSVG}`;
      document.head.appendChild(appleIcon);

      const manifest = {
        name: "Tom Swift’s Green Noise Transmuter",
        short_name: "Green Noise",
        start_url: "./",
        display: "standalone",
        background_color: "#0d2a1b",
        theme_color: "#0d2a1b",
        icons: [
          {
            src: `data:image/svg+xml,${iconSVG}`,
            sizes: "512x512",
            type: "image/svg+xml",
            purpose: "any"
          }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const manifestURL = URL.createObjectURL(manifestBlob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestURL;
      document.head.appendChild(link);

      // Service Worker: cache this single page for offline-ish usage.
      // Note: service workers require HTTPS (or localhost).
      if ('serviceWorker' in navigator){
        const swCode = `
          const CACHE_NAME = 'ts-green-noise-v1';
          self.addEventListener('install', (e) => {
            self.skipWaiting();
            e.waitUntil((async()=>{
              const cache = await caches.open(CACHE_NAME);
              // Cache the root request. In practice, this caches the HTML response.
              try { await cache.add('./'); } catch(e) {}
            })());
          });

          self.addEventListener('activate', (e) => {
            e.waitUntil((async()=>{
              const keys = await caches.keys();
              await Promise.all(keys.map(k => k === CACHE_NAME ? null : caches.delete(k)));
              self.clients.claim();
            })());
          });

          self.addEventListener('fetch', (e) => {
            if (e.request.method !== 'GET') return;
            e.respondWith((async()=>{
              const cache = await caches.open(CACHE_NAME);
              const cached = await cache.match(e.request, {ignoreSearch:true});
              if (cached) return cached;
              try {
                const fresh = await fetch(e.request);
                // only cache same-origin
                if (fresh && fresh.ok && new URL(e.request.url).origin === self.location.origin){
                  cache.put(e.request, fresh.clone());
                }
                return fresh;
              } catch(err){
                return cached || new Response('Offline', {status: 200, headers:{'Content-Type':'text/plain'}});
              }
            })());
          });
        `;
        const swBlob = new Blob([swCode], {type:'text/javascript'});
        const swURL = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swURL).catch(()=>{/* quietly ignore */});
      }
    })();

    // -----------------------------
    // Web Audio: “Green Noise” engine
    // -----------------------------
    let audioCtx = null;
    let noiseNode = null;        // AudioWorkletNode
    let bandpass = null;         // BiquadFilterNode
    let lowpass = null;          // BiquadFilterNode
    let highshelf = null;        // BiquadFilterNode (gentle rolloff)
    let gain = null;             // GainNode
    let analyser = null;         // AnalyserNode
    let master = null;           // GainNode for fade out

    let isPlaying = false;

    // Visualizer
    const canvas = $('#scope');
    const ctx2d = canvas.getContext('2d');
    let rafId = null;

    // Timer
    let countdownSeconds = 0;
    let timerArmedSeconds = 0;
    let timerInterval = null;

    // UI elements
    const btnToggle = $('#btnToggle');
    const btnGlyph = $('#btnGlyph');
    const lamp = $('#lamp');
    const statusText = $('#statusText');
    const sr = $('#sr');
    const countdownEl = $('#countdown');
    const needle = $('#needle');

    const timerRange = $('#timerRange');
    const timerLabel = $('#timerLabel');
    const btnSetTimer = $('#btnSetTimer');
    const btnClearTimer = $('#btnClearTimer');
    const btnReset = $('#btnReset');

    const volRange = $('#volRange');
    const volLabel = $('#volLabel');

    const centerRange = $('#centerRange');
    const centerLabel = $('#centerLabel');
    const qRange = $('#qRange');
    const qLabel = $('#qLabel');

    const modalBackdrop = $('#modalBackdrop');
    const mBody = $('#mBody');
    const btnCloseModal = $('#btnCloseModal');
    const btnAbout = $('#btnAbout');

    // Keep canvas crisp on high DPI
    function resizeCanvas(){
      const dpr = Math.max(1, Math.min(2.25, window.devicePixelRatio || 1));
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
    }

    window.addEventListener('resize', resizeCanvas);

    // AudioWorklet as inline blob
    async function ensureAudio(){
      if (audioCtx) return;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:'interactive'});

      // Inline AudioWorklet source (fast + low overhead compared to ScriptProcessor).
      const workletCode = `
        class WhiteNoiseProcessor extends AudioWorkletProcessor {
          constructor(){
            super();
            // Simple fast PRNG state
            this._seed = 1337;
          }
          _rand(){
            // xorshift32
            let x = this._seed | 0;
            x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
            this._seed = x;
            // map to [-1, 1]
            return (x >>> 0) / 4294967295 * 2 - 1;
          }
          process(inputs, outputs, parameters){
            const out = outputs[0];
            for (let ch=0; ch<out.length; ch++){
              const buf = out[ch];
              for (let i=0; i<buf.length; i++){
                buf[i] = this._rand();
              }
            }
            return true;
          }
        }
        registerProcessor('white-noise', WhiteNoiseProcessor);
      `;

      const workletBlob = new Blob([workletCode], {type:'application/javascript'});
      const workletURL = URL.createObjectURL(workletBlob);
      await audioCtx.audioWorklet.addModule(workletURL);

      // Nodes
      noiseNode = new AudioWorkletNode(audioCtx, 'white-noise', {
        numberOfInputs: 0,
        numberOfOutputs: 1,
        outputChannelCount: [2]
      });

      // --- FILTER CHAIN (this is where the “green” happens) ---
      // We start with white noise (equal energy per Hz), then shape it.
      //
      // “Green noise” doesn’t have a single formal standard like white/pink/brown.
      // Here, we interpret it as “mid-range focused” around ~500 Hz.
      //
      // 1) bandpass @ centerHz (default 500) sets a mid-band emphasis.
      //    - Biquad bandpass passes frequencies near 'frequency' and attenuates others.
      //    - Q controls bandwidth: higher Q = narrower band.
      //
      // 2) lowpass (gentle) reduces extreme top-end hiss so it feels less sharp.
      //
      // 3) a subtle highshelf cut above ~2.5kHz acts like “tape/valve rolloff”.
      //
      // Together, this produces a warm, mid‑centered noise bed.
      bandpass = audioCtx.createBiquadFilter();
      bandpass.type = 'bandpass';
      bandpass.frequency.value = Number(centerRange.value);
      bandpass.Q.value = Number(qRange.value);

      lowpass = audioCtx.createBiquadFilter();
      lowpass.type = 'lowpass';
      lowpass.frequency.value = 3500;
      lowpass.Q.value = 0.7;

      highshelf = audioCtx.createBiquadFilter();
      highshelf.type = 'highshelf';
      highshelf.frequency.value = 2500;
      highshelf.gain.value = -6; // gentle rolloff

      gain = audioCtx.createGain();
      gain.gain.value = Number(volRange.value);

      master = audioCtx.createGain();
      master.gain.value = 0; // start silent until "play"

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.85;

      // Route: noise -> bandpass -> lowpass -> highshelf -> gain -> analyser -> master -> destination
      noiseNode.connect(bandpass);
      bandpass.connect(lowpass);
      lowpass.connect(highshelf);
      highshelf.connect(gain);
      gain.connect(analyser);
      analyser.connect(master);
      master.connect(audioCtx.destination);

      resizeCanvas();
    }

    function setPlayingUI(on){
      isPlaying = on;
      btnToggle.setAttribute('aria-pressed', String(on));
      btnToggle.setAttribute('aria-label', on ? 'Stop transmission' : 'Start transmission');
      btnGlyph.textContent = on ? '❚❚' : '▶';
      lamp.classList.toggle('off', !on);
      statusText.textContent = on ? 'TRANSMITTING' : 'STANDBY';
      sr.textContent = on ? 'Carrier live' : 'Ready';
    }

    function fadeMaster(to, ms){
      if (!audioCtx || !master) return;
      const now = audioCtx.currentTime;
      master.gain.cancelScheduledValues(now);
      const cur = master.gain.value;
      master.gain.setValueAtTime(cur, now);
      master.gain.linearRampToValueAtTime(to, now + ms/1000);
    }

    async function start(){
      await ensureAudio();
      // iOS/Safari: AudioContext may be suspended until user gesture.
      if (audioCtx.state !== 'running') await audioCtx.resume();
      fadeMaster(1, 220);
      setPlayingUI(true);
      startViz();
    }

    function stop({soft=true}={}){
      if (!audioCtx) {
        setPlayingUI(false);
        return;
      }
      if (soft){
        fadeMaster(0, 350);
      } else {
        master.gain.value = 0;
      }
      setPlayingUI(false);
      stopViz();
    }

    // -----------------------------
    // Timer / countdown
    // -----------------------------
    function clearTimer(){
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      countdownSeconds = 0;
      timerArmedSeconds = 0;
      updateCountdownUI();
    }

    function armTimer(seconds){
      clearTimer();
      timerArmedSeconds = seconds;
      countdownSeconds = seconds;
      updateCountdownUI();
      timerInterval = setInterval(()=>{
        countdownSeconds -= 1;
        if (countdownSeconds <= 0){
          countdownSeconds = 0;
          updateCountdownUI();
          clearInterval(timerInterval);
          timerInterval = null;
          // Gentle fade out when timer expires
          stop({soft:true});
          sr.textContent = 'Timer expired';
        } else {
          updateCountdownUI();
        }
      }, 1000);
    }

    function updateCountdownUI(){
      $('#countdown').textContent = fmtHMS(countdownSeconds);
      // subtle needle movement based on remaining proportion (or signal amplitude later)
      const frac = timerArmedSeconds > 0 ? (countdownSeconds / timerArmedSeconds) : (isPlaying ? 1 : 0);
      // Map 0..1 -> -65..65 degrees
      const deg = -65 + 130 * clamp(frac, 0, 1);
      needle.style.transform = `translateX(-50%) rotate(${deg}deg)`;
    }

    // -----------------------------
    // Visualizer (oscilloscope style)
    // -----------------------------
    const timeData = new Uint8Array(2048);

    function draw(){
      if (!analyser) return;
      analyser.getByteTimeDomainData(timeData);

      const w = canvas.width;
      const h = canvas.height;

      // Soft glass glow overlay
      ctx2d.clearRect(0,0,w,h);

      // Background grid
      ctx2d.save();
      ctx2d.globalAlpha = 0.12;
      ctx2d.strokeStyle = '#ffffff';
      ctx2d.lineWidth = 1;
      const stepX = w / 10;
      const stepY = h / 6;
      ctx2d.beginPath();
      for (let i=1;i<10;i++){
        ctx2d.moveTo(i*stepX, 0);
        ctx2d.lineTo(i*stepX, h);
      }
      for (let j=1;j<6;j++){
        ctx2d.moveTo(0, j*stepY);
        ctx2d.lineTo(w, j*stepY);
      }
      ctx2d.stroke();
      ctx2d.restore();

      // Trace
      ctx2d.save();
      ctx2d.lineWidth = Math.max(2, Math.floor(w/420));
      ctx2d.lineJoin = 'round';
      ctx2d.lineCap = 'round';

      // Compute a simple amplitude for gauge/animation
      let peak = 0;
      for (let i=0; i<timeData.length; i++){
        const v = (timeData[i] - 128) / 128;
        peak = Math.max(peak, Math.abs(v));
      }
      // Move needle a bit by peak when playing and no timer
      if (timerArmedSeconds === 0){
        const deg = -65 + 130 * clamp(peak*1.8, 0, 1);
        needle.style.transform = `translateX(-50%) rotate(${deg}deg)`;
      }

      const mid = h * 0.5;
      const glow = 0.18 + peak*0.55;

      // Amber underlay
      ctx2d.globalAlpha = 0.25 + peak*0.25;
      ctx2d.strokeStyle = '#ffcf66';
      ctx2d.beginPath();
      for (let x=0; x<w; x++){
        const i = Math.floor(x / w * timeData.length);
        const v = (timeData[i] - 128) / 128;
        const y = mid + v * (h * 0.34);
        if (x === 0) ctx2d.moveTo(x, y);
        else ctx2d.lineTo(x, y);
      }
      ctx2d.stroke();

      // Green main trace
      ctx2d.globalAlpha = 0.55 + glow;
      ctx2d.shadowColor = 'rgba(69,255,153,.35)';
      ctx2d.shadowBlur = 18 + peak*28;
      ctx2d.strokeStyle = '#45ff99';
      ctx2d.beginPath();
      for (let x=0; x<w; x++){
        const i = Math.floor(x / w * timeData.length);
        const v = (timeData[i] - 128) / 128;
        const y = mid + v * (h * 0.28);
        if (x === 0) ctx2d.moveTo(x, y);
        else ctx2d.lineTo(x, y);
      }
      ctx2d.stroke();

      // Center line
      ctx2d.shadowBlur = 0;
      ctx2d.globalAlpha = 0.16;
      ctx2d.strokeStyle = '#ffffff';
      ctx2d.beginPath();
      ctx2d.moveTo(0, mid);
      ctx2d.lineTo(w, mid);
      ctx2d.stroke();

      ctx2d.restore();

      rafId = requestAnimationFrame(draw);
    }

    function startViz(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(draw);
    }

    function stopViz(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      // leave last frame; that's fine.
    }

    // -----------------------------
    // UI wiring
    // -----------------------------
    function syncTimerLabel(){
      const mins = Number(timerRange.value);
      timerLabel.textContent = humanMinutes(mins);
    }

    function syncVolLabel(){
      const v = Number(volRange.value);
      volLabel.textContent = `${Math.round(v*100)}%`;
      if (gain) gain.gain.setTargetAtTime(v, audioCtx.currentTime, 0.03);
    }

    function syncFilterLabels(){
      centerLabel.textContent = `${Number(centerRange.value)} Hz`;
      qLabel.textContent = `Q ${Number(qRange.value).toFixed(1)}`;

      if (bandpass){
        // Smooth updates; keep mobile-friendly.
        const now = audioCtx.currentTime;
        bandpass.frequency.setTargetAtTime(Number(centerRange.value), now, 0.02);
        bandpass.Q.setTargetAtTime(Number(qRange.value), now, 0.02);
      }
    }

    btnToggle.addEventListener('click', async ()=>{
      try {
        if (!isPlaying) await start();
        else stop({soft:true});
      } catch (e) {
        showModal("The carrier coil refused to energize. If you’re on iOS, ensure the page isn’t muted and try again.");
      }
    });

    btnReset.addEventListener('click', ()=>{
      clearTimer();
      stop({soft:false});
      sr.textContent = 'Reset';
    });

    timerRange.addEventListener('input', syncTimerLabel);
    btnSetTimer.addEventListener('click', ()=>{
      const secs = Number(timerRange.value) * 60;
      armTimer(secs);
      sr.textContent = `Timer armed: ${humanMinutes(Number(timerRange.value))}`;
      updateCountdownUI();
    });

    btnClearTimer.addEventListener('click', ()=>{
      clearTimer();
      sr.textContent = 'Timer cleared';
    });

    volRange.addEventListener('input', syncVolLabel);

    centerRange.addEventListener('input', syncFilterLabels);
    qRange.addEventListener('input', syncFilterLabels);

    // Modal
    function showModal(text){
      mBody.textContent = text;
      modalBackdrop.style.display = 'flex';
    }
    function hideModal(){ modalBackdrop.style.display = 'none'; }

    btnAbout.addEventListener('click', ()=>{
      showModal(
        "This single‑file contraption generates white noise in an AudioWorklet, then shapes it using a band‑pass biquad filter (centered near 500 Hz) plus a gentle low‑pass and high‑shelf rolloff. The result is a warm, mid‑focused wash that’s calmer than full‑spectrum hiss.\n\nTip: for a narrower ‘green beam’, raise Q. For a broader ‘cozy radio fog’, lower Q and nudge the center frequency around 400–650 Hz."
      );
    });

    btnCloseModal.addEventListener('click', hideModal);
    modalBackdrop.addEventListener('click', (e)=>{ if (e.target === modalBackdrop) hideModal(); });

    // Prevent double-tap zoom gestures from doing weird things in some browsers.
    // (We already set user-scalable=no, but this helps on certain touch stacks.)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, {passive:false});

    // Initial UI
    syncTimerLabel();
    syncVolLabel();
    syncFilterLabels();
    updateCountdownUI();

    // If the page goes to background, reduce CPU by stopping viz.
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden) stopViz();
      else if (isPlaying) startViz();
    });

  </script>
</body>
</html>
